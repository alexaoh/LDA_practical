---
title: "Practical Work"
subtitle: "Lifetime Data Analysis"
author: "Rodrigo Arriaza, Alexander J Ohrt"
date: "`r format(Sys.time(), '%d %B, %Y')`"
output: html_document
params:
  show_code = TRUE
---

```{r setup, include=FALSE}
list(rm = ls())
knitr::opts_chunk$set(echo = params$show_code, comment = "#>", eval = TRUE)
library(tidyverse)
library(corrplot)
library(GGally)
library(survival)
```

# Introduction

We are given a data set on sexually transmitted diseases (STDs). This is data from a study about gonorrhea and chlamydia in 877 women. The objective with this practical work is to study possible risk factors for a reinfection with gonorrhea or chlamydia in women who have suffered one of both infections previously. The variables of interest are sociodemographic variables or those related to sexual practice. We have a lot of variables at our disposal, as can be seen from the data set below. We have chosen to use the following variables:

  * Age: The age of the woman. 
  * NumPartners: The number of partners during the last 30 days. 
  * CondomUse: Use of condoms (1: always, 2: once in a while, 3: never)
  * Ethnicity (B: Black; W: White)
  * YearsSchool: Years of schooling. 
  * SignDischarge (1: yes; 0: no)
  * **Some more? Maybe based on something else?**

The first four were chosen based on results from a [study](https://www.ncbi.nlm.nih.gov/pmc/articles/PMC1744639/) on gonorrhea reinfection in heterosexual STD clinic attendees. The study concluded that increased reinfection risk (of gonorrhea) was associated with younger age and a greater number of recent sex partners, among other risk factors. Moreover, the authors concluded that any type of condom use was a risk factor for reinfection with gonorrhea in women. These results are interesting, which is why we want to see what we would conclude from our data. Lastly, the authors of the study report that 95\% of the subjects of the study where African-American, which means that they did not analyse ethnicity in their study. This is something we would like to investigate in our data. 

Another [publication](https://policylab.chop.edu/sites/default/files/pdf/publications/Preventing_Chlamydia_Gonorrhea_Reinfection_through_Increased_Use_of_EPT.pdf) reports that, on average, 14\% of women with clamydia and 12\% of women with gonorrhea get reinfected, with younger women at higher risk. Moreover, they state that many adolescents treated for infection of one of the two STDs are reinfected within three to six months, usually because of resumed sexual contact with an untreated partner. Thus, the marital status might be interesting to analyse. However, this is not added after all, because, as seen in the exploratory data analysis below, the ages are low, which should mean that the amount in each level of `MaritalStatus` is very skewed towards single. This can be seen in the table below as well. 

[This meta-analysis](https://www.ncbi.nlm.nih.gov/pmc/articles/PMC2094865/) reports that the relationship between race, socioeconomic status (SES) and chlamydial infection is not clear. It concludes that SES was not associated with chlamydia infection, where they tested for several variables, where level of parent's education was one of them. Either way, we think it might be interesting to see if the years of schooling of the women have any impact on chlamyida reinfection. Note that age naturally will limit the amount of schooling attained for the subject, which means that they might be correlated. As will be seen below, they are somewhat correlated **Don't use this then?**

Next, `SignDischarge` is chosen since vaginal discharge is a common symptom of chlamydia **But should we choose SignDischarge or DischargeExam?**.




```{r}
std_data <- read.table("STD_onlydata.txt")
colnames(std_data) <- variable.names <- c("ObsNum", "Ethnicity", "MaritalStatus", "Age", "YearsSchool", "InitInfect", "NumPartners", "OralSex12m", 
                        "OralSex30d", "RectalSex12m", "RectalSex30d", "AbPain", "SignDischarge", "SignDysuria", "CondomUse", 
                        "SignItch", "SignLesion", "SignRash", "SignLymph", "InvVagAtExam", "DischargeExam", "AbnormNodeExam", 
                        "Reinfection", "TimeUntilReinf")

std_data[, variable.names[-c(1, 4, 5, 7, 24)]] <- lapply(std_data[, variable.names[-c(1, 4, 5, 7, 24)]], factor)
std_data$cens <- rep(1, length = dim(std_data)[[1]]) # All uncensored, thus cens = 1 for all rows. 

variables.chosen <- c("Age", "NumPartners", "CondomUse", "Ethnicity")
continuous.variables <- unlist(lapply(std_data, is.numeric))
continuous.variables <- continuous.variables[-length(continuous.variables)] # Removing the cens-value. 
```

Naturally, the categorical variable which states if the woman is reinfected or not (`Reinfection`) will be used as a dependent variable in the analysis. **Should one include TimeUntilReinf also?** 

# Descriptive Analysis


```{r}
# Find a way to print it nicely!
knitr::kable(summary(std_data))
```


```{r}
hist(std_data[, "Age"], breaks = 100)
```

```{r, echo = F}
knitr::kable(table(std_data[, "MaritalStatus"]), col.names = c("Marital Status", "Frequency"), caption = "Marital Status Frequency in each Level.")
knitr::kable(table(std_data[, "SignDischarge"]), col.names = c("Sign of Discharge", "Frequency"), caption = "Sign of Discharge Frequency in each Level.")
knitr::kable(table(std_data[, "DischargeExam"]), col.names = c("Discharge at Exam", "Frequency"), caption = "Discharge at Exam Frequency in each Level.")
# Some more tables?
```

Pairs plot of the chosen variables. **Nothing really interested to see here perhaps?**
```{r}
ggpairs(std_data[,continuous.variables])
corrplot(cor(std_data[, continuous.variables]))
```
Note that age and years of schooling are somewhat correlated. **Could do some more EDA probably, and should remove some of this also.** 

# Nonparametric Analysis

The survival curve is estimated by means of Kaplan-Meier and plotted below. 

```{r}
s1 <- with(std_data, Surv(TimeUntilReinf, cens))
s1fit <- survfit(s1 ~ 1)
plot(s1fit)

plot(s1fit, col = 2, xlab = "Time to reinfection [days]",
     ylab = expression(bolditalic(hat(S)(t))),
     lty = 1, lwd = 3, yaxs = "i", xaxs = "i", bty = "n",
     conf.int = F)
title("Survival function")
# Very smooth function! Should limit the time a bit perhaps?
```

The median survival time is 247 days, as can be seen below. 

```{r}
s1fit
```

Comparison of survival functions by means of nonparametric tests, such as the logrank test. 

# Fit of a parametric survival model

# Fit of a semi-parametric survival model

# Conclusions
