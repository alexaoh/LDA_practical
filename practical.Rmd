---
title: "Practical Work"
subtitle: "Lifetime Data Analysis"
author: "Rodrigo Arriaza, Alexander J Ohrt"
date: "`r format(Sys.time(), '%d %B, %Y')`"
output:
  bookdown::pdf_book:
    keep_tex: true
    toc: false
    number_sections: false
params:
  show_code = TRUE
---

```{r setup, include=FALSE}
list(rm = ls())
knitr::opts_chunk$set(echo = params$show_code, comment = "#>", eval = TRUE, warning = F, fig.height=4)
library(tidyverse)
library(corrplot)
library(GGally)
library(survival)
library(FHtest) 
library(GofCens)
```

# Introduction

We are given a data set on sexually transmitted diseases (STDs). This is data from a study about gonorrhea and chlamydia in 877 women. The objective with this practical work is to study possible risk factors for a reinfection with gonorrhea or chlamydia in women who have suffered one of both infections previously. The variables of interest are sociodemographic variables or those related to sexual practice. We have a lot of variables at our disposal, as can be seen from the data set below. We have chosen to use the following:

  * Age: The age of the woman. 
  * NumPartners: The number of partners during the last 30 days. 
  * CondomUse: Use of condoms (1: always, 2: once in a while, 3: never)
  * YearsSchool: Years of schooling. 
  * InitInfect: Initial infection (1: Gonorrhea, 2: Chlamydia, 3: both)
  * InvVagAtExam: Involvement vagina at exam (1: yes; 0: no). 
  * DischargeExam: Discharge at exam (1: yes; 0: no)

The first two were chosen based on results from a [study](https://www.ncbi.nlm.nih.gov/pmc/articles/PMC1744639/) on gonorrhea reinfection in heterosexual STD clinic attendees. The study concluded that increased reinfection risk (of gonorrhea) was associated with younger age and a greater number of recent sex partners, among other risk factors. Moreover, the authors concluded that any type of condom use was a risk factor for reinfection with gonorrhea in women. However by using statistical analysis we found that the Age of the woman and the ethnicity (a variable that was not included in the aforementioned study) are not statistically significant (Necessary to mention Ethnicity here, if it is not a part of the study?). Q: Should perhaps describe what we have done and why it has been done? I am going to ask Klaus about what he thinks about it also I think, just to see what he says. 

Another [publication](https://policylab.chop.edu/sites/default/files/pdf/publications/Preventing_Chlamydia_Gonorrhea_Reinfection_through_Increased_Use_of_EPT.pdf) reports that, on average, 14\% of women with clamydia and 12\% of women with gonorrhea get reinfected, with younger women at higher risk. Moreover, they state that many adolescents treated for infection of one of the two STDs are reinfected within three to six months, usually because of resumed sexual contact with an untreated partner. Thus, the marital status might be interesting to analyse. However, this is not added, because, as seen in the exploratory data analysis below, the ages are low, which should mean that the amount in each level of `MaritalStatus` is very skewed towards single. This can be seen in the table below as well. NOT SURE IF WE SHOULD KEEP THIS, DEPENDS ON THE AMOUNT OF ROOM I GUESS. can leave it until the end. 

[This meta-analysis](https://www.ncbi.nlm.nih.gov/pmc/articles/PMC2094865/) reports that the relationship between race, socioeconomic status (SES) and chlamydial infection is not clear. It concludes that SES was not associated with chlamydia infection, where they tested for several variables, where level of parent's education was one of them. Either way, we think it might be interesting to see if the years of schooling of the women have any impact on chlamydia reinfection and as is shown below it showed to be statistically significant during the exploratory analysis. Q: I also think that this would be a reason to look at race also (combined with the first study, where they only had afro-americans. Perhaps we can try to mix the variables chosen based on studies and on the statistical method? (that is; if this statistical method is something we can trust))

InitInfect is interesting to use, because several of the studies above are only done on one of the two diseases, not on both at the same time. Also "almost" statistically significant, even though this is not very precise at all. 


```{r}
std_data <- read.table("STD_onlydata.txt")
colnames(std_data) <- variable.names <-c("ObsNum", "Ethnicity", "MaritalStatus", 
        "Age", "YearsSchool", "InitInfect", "NumPartners", "OralSex12m", 
        "OralSex30d", "RectalSex12m", "RectalSex30d", "AbPain", 
        "SignDischarge","SignDysuria","CondomUse","SignItch","SignLesion",
        "SignRash","SignLymph","InvVagAtExam","DischargeExam","AbnormNodeExam", 
        "Reinfection", "TimeUntilReinf")
non_factor_indices <- c(1, 4, 5, 7,23, 24) 
std_data[, variable.names[-non_factor_indices]] <- lapply(
  std_data[, variable.names[-non_factor_indices]],factor)

covariates.chosen <- c("Age", "NumPartners", "CondomUse", 
                      "YearsSchool", "InitInfect", "InvVagAtExam", "DischargeExam") # ETC!
continuous.covar <- unlist(lapply(std_data, is.numeric)) 
continuous.covar["Reinfection"] <- FALSE # Remove Reinfection also. 
```

Naturally, the categorical variable which states if the woman is reinfected or not (`Reinfection`) will be used as a dependent variable in the analysis and the time until reinfection since the more time a subject is under study, the greater the risk of the event reoccurring.

## Variable selection 

Q: What is the offset(log(TimeUntilReInf))? I don't understand this to be honest ;) Can you explain?

```{r variable-select}
#std_data$Ethnicity <- factor(std_data$Ethnicity)
nb.model <- MASS::glm.nb(Reinfection ~ Ethnicity + MaritalStatus + Age + YearsSchool + InitInfect +
                           NumPartners +OralSex12m + OralSex30d + RectalSex12m + RectalSex30d + AbPain +
               SignDischarge + SignDysuria+ CondomUse + SignItch + SignLesion + SignRash +
               SignLymph + InvVagAtExam + DischargeExam + AbnormNodeExam + offset(log(TimeUntilReinf)),
             data=std_data)
s <- summary(nb.model)
k <- knitr::kable(s$coefficients, caption = 'Variables Statistical Significance')
kableExtra::row_spec(k, c(6,23,24), color='white', background = 'blue')
```

# Descriptive Analysis

```{r, include=F}
# Find a way to print it nicely!
knitr::kable(summary(std_data))
```

The percentage of right-censored data in the data set is given below

```{r}
dim(std_data[std_data$Reinfection == 0,])[[1]]/dim(std_data)[[1]]*100
```


```{r, include=T}
hist(std_data[, "Age"], breaks = 100)
```

```{r, include=T}
knitr::kable(table(std_data[, "MaritalStatus"]), col.names = c("Marital Status", "Frequency"), caption = "Marital Status Frequency in each Level.")
knitr::kable(table(std_data[, "SignDischarge"]), col.names = c("Sign of Discharge", "Frequency"), caption = "Sign of Discharge Frequency in each Level.")
knitr::kable(table(std_data[, "DischargeExam"]), col.names = c("Discharge at Exam", "Frequency"), caption = "Discharge at Exam Frequency in each Level.")
# Some more tables?
```

[//]: # Pairs plot of the chosen variables. **Nothing really interested to see here perhaps?**

```{r, include=T}
ggpairs(std_data[,continuous.covar])
corrplot(cor(std_data[, continuous.covar])) # Correlation between continuous variables. 
```
Note that age and years of schooling are somewhat correlated. **Could do some more EDA probably, and should remove some of this also.** 

# Nonparametric Analysis

The survival curve is estimated by means of Kaplan-Meier and plotted below. The curve below shows the general survival in the data set.

```{r, echo = F}
s1 <- with(std_data, Surv(TimeUntilReinf, Reinfection) ~ 1)
s1fit <- survfit(s1)
#plot(s1fit)

par(font = 2, font.axis = 2, font.lab = 2, las = 1, mar = c(5, 5, 4, 2))
plot(s1fit, col = 2, xlab = "Time to reinfection [days]",
     ylab = expression(bolditalic(hat(S)(t))),
     lty = 1, lwd = 3, yaxs = "i", xaxs = "i", bty = "n",
     conf.int = F)
title("Survival Function")
```

```{r}
s1.CondomUse <- with(std_data, Surv(TimeUntilReinf, Reinfection) ~ CondomUse)
s1fit.CondomUse <- survfit(s1.CondomUse)
par(font = 2, font.axis = 2, font.lab = 2, las = 1, mar = c(5, 5, 4, 2))
plot(s1fit.CondomUse, col = c(1,2,3), xlab = "Time to reinfection [days]",
     ylab = expression(bolditalic(hat(S)(t))),
     yaxs = "i", xaxs = "i", bty = "n", lty = c(1,2,3), lwd = rep(3, length.out = 3),
     conf.int = F)
legend("topright", legend = levels(std_data$CondomUse), title = "Condom Use",
       bty = "n", col = c(1,2,3), lty = c(1,2,3), lwd = rep(3, length.out = 3))
title("Survival Function as Function of Condom Use")
```

```{r}
s1.Ethnicity <- with(std_data, Surv(TimeUntilReinf, Reinfection) ~ Ethnicity)
s1fit.Ethnicity <- survfit(s1.Ethnicity)
par(font = 2, font.axis = 2, font.lab = 2, las = 1, mar = c(5, 5, 4, 2))
plot(s1fit.Ethnicity, col = c(1,2), xlab = "Time to reinfection [days]",
     ylab = expression(bolditalic(hat(S)(t))),
     yaxs = "i", xaxs = "i", bty = "n", lty = c(1,2), lwd = rep(3, length.out = 2),
     conf.int = F)
legend("topright", legend = levels(std_data$Ethnicity), title = "Ethnicity",
       bty = "n", col = c(1,2), lty = c(1,2), lwd = rep(3, length.out = 2))
title("Survival Function as Function of Ethnicity")
```

```{r}
s1.SignDischarge <- with(std_data, Surv(TimeUntilReinf, Reinfection) ~ SignDischarge)
s1fit.SignDischarge <- survfit(s1.SignDischarge)
par(font = 2, font.axis = 2, font.lab = 2, las = 1, mar = c(5, 5, 4, 2))
plot(s1fit.SignDischarge, col = c(1,2), xlab = "Time to reinfection [days]",
     ylab = expression(bolditalic(hat(S)(t))),
     yaxs = "i", xaxs = "i", bty = "n", lty = c(1,2), lwd = rep(3, length.out = 2),
     conf.int = F)
legend("topright", legend = levels(std_data$SignDischarge), title = "Sign of Discharge",
       bty = "n", col = c(1,2), lty = c(1,2), lwd = rep(3, length.out = 2))
title("Survival Function as Function of Sign of Discharge")
```


```{r}
s1.NumPartners <- with(std_data, Surv(TimeUntilReinf, Reinfection) ~ NumPartners)
s1fit.NumPartners <- survfit(s1.NumPartners)
par(font = 2, font.axis = 2, font.lab = 2, las = 1, mar = c(5, 5, 4, 2))
plot(s1fit.NumPartners, col = c(1,2,3,4,5,6,7,8,9), xlab = "Time to reinfection [days]",
     ylab = expression(bolditalic(hat(S)(t))),
     yaxs = "i", xaxs = "i", bty = "n", lty = c(1,2,3,4,5,6,7,8,9), lwd = rep(3, length.out = 9),
     conf.int = F)
legend("topright", legend = levels(as.factor(std_data$NumPartners)), title = "Number of Partners",
       bty = "n", col = c(1,2,3,4,5,6,7,8,9), lty = c(1,2,3,4,5,6,7,8,9), lwd = rep(3, length.out = 9))
title("Survival Function as Function of Number of Partners")
```


The median survival time is `r summary(s1fit)$table["median"][[1]]` days.

Comparison of survival functions by means of nonparametric tests, such as the logrank test. 

Below, logrank test for all curves plotted above are done. Other types of tests can also be used (Fleming-Harrington) and test can be done on different variables in the data set. 

```{r}
FHtestrcc(s1.CondomUse)
FHtestrcc(s1.Ethnicity)
FHtestrcc(s1.SignDischarge)
FHtestrcc(s1.NumPartners)
```

# Fit of a parametric survival model

After trying to fit Weibull, log-logistic and lognormal log-linear models, we concluded that the Weibull model is best suited to our data.

```{r, include = F}
# Below we have the null models. 
s2 <- with(std_data, Surv(TimeUntilReinf, Reinfection))
loglo <- survreg(s2 ~ 1, dist = "loglo")  
summary(loglo)
weibull <- survreg(s2 ~ 1)
summary(weibull)
lognormal <- survreg(s2 ~ 1, dist = "lognormal")
summary(lognormal)
```

**The correct varliables should be inserted here after we decide on them!!**
```{r fit-weibull}
s2 <- with(std_data, Surv(TimeUntilReinf, Reinfection))
# This should be done first with Weibull, to avoid having the log-fit here. 
weibull.full  <- survreg(s2 ~ Age + NumPartners + CondomUse + YearsSchool 
                  + InitInfect + InvVagAtExam + DischargeExam, data = std_data, dist = "weibull")
(s.weibull <- summary(weibull.full))
#weibull.full <- survreg(s2 ~ ., data = std_data, dist = "weibull")
#(s.weibull <- summary(weibull.full))

weibull.pred <- predict(weibull.full, type = "linear")
resids.weibull <- (log(std_data$TimeUntilReinf) - weibull.pred) / weibull.full$scale
```

```{r}
par(font = 2, font.axis = 2, font.lab = 2, las = 1, mar = c(5, 5, 4, 2))
plot(survfit(Surv(resids.weibull, std_data$Reinfection) ~ 1), col = c(1,2,2), xlab = "Residuals",
     ylab = expression(bolditalic(hat(S)(t))),
     lty = 1, lwd = 3, yaxs = "i", xaxs = "i", bty = "n")
title("Residuals of the Weibull Regression Model")
survgumb <- function(x) {
  return(exp(-exp(x)))
}
curve(survgumb, from = min(resids.weibull), to = max(resids.weibull), col = 3, lwd = 3,
      add = TRUE)
legend("bottomleft", c("KM estimate", "95% - CI", "Stand. Gumbel Distribution"),
       col = c(1, 2, 3), lty = c(1, 2, 1), lwd = 3, bty = "n")
```

The residuals seem to fit relatively nicely to the Gumbel distribution, which indicates that the Weibull is reasonable to use **Check that the terminology I used here is correct!**

```{r fit-lognormal}
lognormal.full <- update(weibull.full, dist = "lognormal")
summary(lognormal.full)
lognormal.pred <- predict(lognormal.full, type = "linear")
resids.logno <- (log(std_data$TimeUntilReinf) - lognormal.pred) / lognormal.full$scale

par(font = 2, font.axis = 2, font.lab = 2, las = 1, mar = c(5, 5, 4, 2))
plot(survfit(Surv(resids.logno, std_data$Reinfection) ~ 1), col = c(1,2,2), xlab = "Residuals",
     ylab = expression(bolditalic(hat(S)(t))),
     lty = 1, lwd = 3, yaxs = "i", xaxs = "i", bty = "n")
title("Residuals of the Lognormal Regression Model")
curve(pnorm(x, lower.tail = F), from = min(resids.logno), to = max(resids.logno), col = 3, lwd = 3,
      add = TRUE)
legend("bottomleft", c("KM estimate", "95% - CI", "Stand. Normal Distribution"),
       col = c(1, 2, 3), lty = c(1, 2, 1), lwd = 3, bty = "n")
```

```{r fit-loglog}
loglo.full <- update(weibull.full, dist = "loglo")
summary(loglo.full)
loglo.pred <- predict(loglo.full, type = "linear")
resids.loglo <- (log(std_data$TimeUntilReinf) - loglo.pred) / loglo.full$scale

par(font = 2, font.axis = 2, font.lab = 2, las = 1, mar = c(5, 5, 4, 2))
plot(survfit(Surv(resids.loglo, std_data$Reinfection) ~ 1), col = c(1,2,2), xlab = "Residuals",
     ylab = expression(bolditalic(hat(S)(t))),
     lty = 1, lwd = 3, yaxs = "i", xaxs = "i", bty = "n")
title("Residuals of the log-logistic Regression Model")
curve(plogis(x, lower.tail = F), from = min(resids.loglo), to = max(resids.loglo), col = 3, lwd = 3,
      add = TRUE)
legend("bottomleft", c("KM estimate", "95% - CI", "Stand. Logistic Distribution"),
       col = c(1, 2, 3), lty = c(1, 2, 1), lwd = 3, bty = "n")
```

```{r cumhaz-plot, results = "hide", fig.height=3}
cumhazPlot(std_data$TimeUntilReinf, std_data$Reinfection,col = 4, distr = c("wei", "loglo", "lognormal"), font.lab = 4)
```

The probability plots above also show that the Weibull is the better parametric model for the data, because the log-logistic and lognormal models clearly do not fit the line in the tails. 

But how do we interpret this model fit? First of all, the model we have fit has the expression

$$
Y = \ln(T) = \mu + \mathbf{\gamma}^T\mathbf{Z} + \sigma W,  
$$

where $W \sim EV(0,1)$, 

$$
\mathbf{\gamma}^T = (\gamma_{Age}, \gamma_{Ethn.}, \gamma_{NumPartn.}, \gamma_{Cond.}, \gamma_{YSchool}, \gamma_{SignDisch}) 
$$

are the estimated parameters and 

$$
\mathbf{Z}^T = (Age, Ethn., NumPartn., Cond., YSchool, SignDisch), 
$$

is the vector of values. **These need to be changed according to the values used also!!** Thus, each of the quantities $\exp(\gamma_i)$s can be interpreted as the unitary change in time until reinfection (when the covariate $i$ is continuous), or the change in time until reinfection when changing level (when the covariate $i$ is categorical with different levels), when the other explanatory variables are kept fixed. **Any other interpretation of the model fit they are looking for you think?**

In the Weibull model, the acceleration factor (AF) is calculated using the equation

$$
AF = \exp(-\hat{\gamma}_i)
$$
and the hazard ratio (HR) is calculated using the equation 

$$
HR = \exp(-\hat{\gamma}_i/\hat{\sigma}).
$$
In this case, the model fit gives the scale $\hat{\sigma} \approx$ `r round(s.weibull$scale, 3)`. These values are calculated for each of the covariates below. 

```{r, echo = F}
df <- data.frame("Parameter Estimate" = s.weibull$coefficients, "AF" = exp(-s.weibull$coefficients), 
                 "HR" =  exp(-s.weibull$coefficients/s.weibull$scale))
knitr::kable(df, caption = "Parameter Estimates, AF and HR for each Parameter Estimate")
```

Consider an example using the covariate `CondomUse` when explaining the interpretation of the covariates in terms of the AF. From the table above it is apparent that the AF of `CondomUse3` versus `CondomUse1` is $\approx$ `r round(exp(-s.weibull$coefficients)["CondomUse3"][[1]], 3)`. This means that the reinfection time for a person that never uses a condom is $\approx$ `r round(exp(-s.weibull$coefficients)["CondomUse3"][[1]], 3)` times the reinfection time for a person that always uses a condom **Not sure that this makes sense!? I think it makes sense with the coefficient value given from the model above, but does not make sense in real life, as this suggests that not using a condom is protective!** The interpretation in terms of the AF is similar when considering the other covariates, except for when considering the `Age` and `NumPartners`, which is not categorical **Perhaps it indeed makes sense to considering the Age in this way also, even though it is weird to treat the Age this way?**

The relative hazards (RH) can be calculated using the equation ...

**Is the relative hazards the same as the hazard ratio??**

# Fit of a semi-parametric survival model

The proportional hazards model is fit. **This is probably done in next lab!**

# Conclusions
